# 宝塔面板部署指南

## 前置要求

1. 宝塔面板已安装 Docker 插件
2. 服务器已安装 Docker 和 Docker Compose
3. 服务器至少 2核4G内存，40G硬盘

## 部署步骤

### 方式一：使用 Docker Compose（推荐）

#### 1. 上传文件到服务器

将以下文件上传到服务器目录（例如 `/www/wwwroot/new_year_exchange/`）：
- `docker-compose.yml`
- `backend/` 目录（包含 `Dockerfile.baota`、`package.json`、`src/`、`data/`）
- `frontend/` 目录（包含 `Dockerfile.baota`、`package.json`、`nginx.conf`、`src/`）

#### 2. 修改 docker-compose.yml

将 `docker-compose.yml` 中的 Dockerfile 路径修改为使用 `.baota` 版本：

```yaml
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.baota
    container_name: new-year-exchange-backend
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./data:/app/data
    environment:
      - PORT=3000
      - TZ=Asia/Shanghai
      - NODE_ENV=production
      - JWT_SECRET=your-secret-key-change-this-in-production

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.baota
    container_name: new-year-exchange-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend
    environment:
      - TZ=Asia/Shanghai
```

#### 3. 启动服务

在宝塔面板的终端中执行：

```bash
cd /www/wwwroot/new_year_exchange
docker-compose up -d --build
```

### 方式二：使用宝塔面板 Docker 插件

#### 1. 后端部署

1. 登录宝塔面板
2. 进入「软件商店」→「Docker」→「镜像」
3. 点击「构建镜像」
4. 填写配置：
   - 镜像名称：`new-year-exchange-backend`
   - 构建上下文：`/www/wwwroot/new_year_exchange/backend`
   - Dockerfile 路径：`Dockerfile.baota`
5. 点击「构建」
6. 构建完成后，进入「容器」→「创建容器」
7. 填写配置：
   - 容器名称：`new-year-exchange-backend`
   - 镜像：`new-year-exchange-backend:latest`
   - 端口映射：`3000:3000`
   - 卷映射：`/www/wwwroot/new_year_exchange/data:/app/data`
   - 环境变量：
     - `PORT=3000`
     - `TZ=Asia/Shanghai`
     - `NODE_ENV=production`
     - `JWT_SECRET=your-secret-key-change-this-in-production`
8. 点击「创建」

#### 2. 前端部署

1. 在 Docker 镜像页面，点击「构建镜像」
2. 填写配置：
   - 镜像名称：`new-year-exchange-frontend`
   - 构建上下文：`/www/wwwroot/new_year_exchange/frontend`
   - Dockerfile 路径：`Dockerfile.baota`
3. 点击「构建」
4. 构建完成后，进入「容器」→「创建容器」
5. 填写配置：
   - 容器名称：`new-year-exchange-frontend`
   - 镜像：`new-year-exchange-frontend:latest`
   - 端口映射：`80:80`
6. 点击「创建」

### 方式三：使用宝塔面板网站部署

#### 1. 创建网站

1. 进入宝塔面板「网站」→「添加站点」
2. 填写域名（例如：`example.com`）
3. PHP版本选择「纯静态」
4. 点击「提交」

#### 2. 上传前端文件

1. 进入网站根目录：`/www/wwwroot/example.com`
2. 删除默认文件
3. 上传前端构建产物（`dist` 目录下的所有文件）
4. 或者在本地构建后上传

#### 3. 配置反向代理（后端）

1. 进入网站设置→「反向代理」
2. 点击「添加反向代理」
3. 填写配置：
   - 代理名称：`backend`
   - 目标URL：`http://127.0.0.1:3000`
   - 发送域名：`$host`
4. 点击「提交」

#### 4. 部署后端服务

按照「方式二」中的步骤部署后端容器，但不需要映射端口到外部，仅使用内部网络。

## 配置说明

### Nginx 配置（frontend/nginx.conf）

确保 `nginx.conf` 包含以下配置：

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 环境变量

后端服务需要的环境变量：
- `PORT=3000` - 服务端口
- `TZ=Asia/Shanghai` - 时区
- `NODE_ENV=production` - 运行环境
- `JWT_SECRET=your-secret-key-change-this-in-production` - JWT密钥（生产环境必须修改）

## 访问应用

部署完成后，访问：
- 前端：`http://your-domain.com`
- 管理员后台：`http://your-domain.com/admin`
- 后端API：`http://your-domain.com/api`

## 管理命令

```bash
# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 更新服务
git pull
docker-compose up -d --build
```

## 常见问题

### 1. 端口被占用

检查端口占用：
```bash
netstat -tlnp | grep 80
netstat -tlnp | grep 3000
```

### 2. 容器无法启动

查看容器日志：
```bash
docker logs new-year-exchange-backend
docker logs new-year-exchange-frontend
```

### 3. 数据库问题

确保数据目录权限正确：
```bash
chmod -R 755 /www/wwwroot/new_year_exchange/data
```

### 4. 前端无法访问后端

检查 Nginx 配置中的代理地址是否正确，确保后端容器正常运行。

## 安全建议

1. 修改默认管理员密码
2. 使用 HTTPS（在宝塔面板中申请 SSL 证书）
3. 配置防火墙规则，仅开放必要端口
4. 定期备份数据目录
5. 修改 JWT_SECRET 为强密码

## 备份与恢复

### 备份

```bash
# 备份数据库
cp /www/wwwroot/new_year_exchange/data/cards.sqlite /backup/cards.sqlite.$(date +%Y%m%d)

# 备份配置
tar -czf backup_$(date +%Y%m%d).tar.gz /www/wwwroot/new_year_exchange
```

### 恢复

```bash
# 恢复数据库
cp /backup/cards.sqlite.20250124 /www/wwwroot/new_year_exchange/data/cards.sqlite

# 重启容器
docker-compose restart
```

## 技术支持

- 查看宝塔面板日志
- 检查 Docker 容器日志
- 联系项目开发团队
